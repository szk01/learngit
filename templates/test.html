<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>来电通知</title>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/socket.io/1.5.1/socket.io.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
        }
        #phone-note {
            margin: 10px 5px;                 /* 上下 左右 */
            height: 60px;
            /*border: 1px solid #000;*/
            background-color: #EEE9E9;
            display: none;

        }

        ul li {
            list-style: none;
            float: left;
            margin: 20px 10px;
            width: 200px;
        }
        .cdr {
            font-weight: bold;
        }
        .number {
            /*width: 200px;*/
            /*border: 1px solid #000;*/

        }
        .status {
            /*width: 200px;*/
            /*border: 1px solid #000;*/
        }
        .time {
            /*width: 200px;*/
            /*border: 1px solid #000;*/
        }
        .bt {
            font-size: 15px;
            cursor: pointer;
            background-color: #008CBA;     /* 蓝色*/
            color: white;                  /* 文字颜色*/
        }
    </style>
</head>
<body>
    <h2>使用webSocket协议</h2>

    <ul id="phone-note">
        <li class="cdr">通话记录</li>
        <li class="number"><em>来电号码</em></li>
        <li class="status">呼叫中...</li>
        <li class="time">呼叫时长</li>
        <li>
            <button class="bt">关闭</button>
        </li>
    </ul>


<script type="text/javascript">
    $(function() {
            function timeing(status) {                                              // 计时器函数
                var count = 0
                var timeshow = '00:00'
                var interval = null
                function timedCount() {
                    count += 1
                    show(count)
                    console.log(timeshow)
                    $('.time').text(timeshow)
                }
                function show(count) {
                    if (count < 60 ) {
                        timeshow = '00:'+count.toString()
                    }
                    if (count > 60 || count === 60) {
                        var min = count / 60
                        var sec = count % 60
                        min = Math.floor(min)                       /*小数取整*/
                        timeshow = min.toString()+':'+sec.toString()
                    }
                }
                if (status == 'start') {
                     if(interval!=null){                            //判断计时器是否为空
					    clearInterval(interval);
					    interval=null;
				     }
                     interval = setInterval(timedCount, 1000)               /*每隔一秒就执行一次*/
                }
                if (status == 'end')
                     clearInterval(interval);
				     interval = null;
				     console.log('通话已结束')

            }

        var url = "http://106.15.44.224:80";
        console.log(url);
        var socket = io.connect(url);
        socket.on('connect', function() {
            socket.emit('login', {data: 'client send message sucessfully!'});
        });                                                          // 这些都是套路函数，建立通道，发送提示消息

        socket.on("number", function(data) {                         // 有电话拨打进来，显示来电号码
            <!--alert(data+'来电');-->
            $('#phone-note').show();
            $('.number').text('来电'+data)
            $('.time').text('00:00')
        });

        socket.on("anwser", function(data) {                          // 分机应答，显示状态
            if (data === 'ANWSER') {
                $('.status').text('通话已建立');
                <!--计时器-->
                timeing('start')                                      // 开始计时
            }
        });

        socket.on("end", function(data) {                             // 分机或者来访者挂断，显示状态
            if (data === 'END') {
                $('.status').text('通话已结束');
                timeing('end')                            // 停止计时
                console.log('停止计时')
            }
        });


        // 点击关闭显示框
        $(".bt").click(function(){
            $('#phone-note').hide();
        });
    });
</script>
</body>
</html>